<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>
      Pomelo
    </title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta http-equiv="content-style-type" content="text/css" />
    <meta http-equiv="content-scripte-type" content="text/javascript" />
    <meta name="author" content="netease" />
    <meta name="version" content="1.0" />
    <meta name="keywords" content="pomelo" />
    <!-- Bootstrap -->
    <link type="text/css" rel="stylesheet" href="css/base.css" />
    <script src="js/lib/jquery-1.8.0.min.js" type="text/javascript">
    </script>
    <script src="js/lib/build/build.js" type="text/javascript"></script>
    <script type="text/javascript">
      require('boot');
    </script>
    <script src="js/client.js">
    </script>
    <script src="js/emotion.js">
    </script>
    <script src="js/ui.js">
    </script>


    <script src="js/lib/socket.io.js">
    </script>

    <script src="js/lib/pomeloclient.js">
    </script>


    <script type="text/javascript">
      var pomelo = window.pomelo;
      var host = "172.16.9.65";
      var port = "3010";

      function entry() {
        var fromUserId = parseInt($("#uid").attr("value"));
        pomelo.init({
          host: host,
          port: port,
          log: true
        }, function() {
        pomelo.request("connector.entryHandler.entry", {uid: fromUserId}, function(data) {

          });
        });
        showMsg(fromUserId);
      }
      function sendChat() {
          var fromUserId = parseInt($("#uid").attr("value"));
          var toUserId = parseInt($("#toUid").attr("value"));
          var content = $("#msg").attr("value");
          pomelo.request("chat.chatHandler.sendChat", {from:fromUserId, to:toUserId, msg:{type:'txt', content:content}}, function(data) {

          });
      }
      function sendGroupChat() {
          var fromUserId = parseInt($("#uid").attr("value"));
          var groupId = parseInt($("#groupId").attr("value"));
          var content = $("#msg").attr("value");
          pomelo.request("chat.chatHandler.sendChat", {from:fromUserId, group:groupId, msg:{type:'txt', content:content}}, function(data) {

          });
      }

      function ack(reader, id, chatType) {
          pomelo.notify("chat.chatHandler.ack", {uid:reader, id: id, chatType: chatType}, function(data) {
          });
      }

      function showMsg(reader) {
          pomelo.on('chatMsg', function(data) {
              if (!!data.to) {
                  addMessage(data.from, data.to, data.msg.content);
              }
              else if(!!data.group) {
                  addGroupMessage(data.from, data.group, data.msg.content);
              }
              if(!!data.id) {
                  var chatType = !!data.group ? 1 : 0;   // 1 表示群聊  0　表示单聊
                  ack(reader, data.id, chatType);
              }
              $("#chatHistory").show();

          });

          pomelo.on('unReceivedMsg', function(data) {
              var unReceivedGroupChats = data.unReceivedGroupChats;
              for(var i in unReceivedGroupChats) {
                  var groupChat = unReceivedGroupChats[i];
                  addGroupMessage(groupChat.from, groupChat.group, groupChat.msg.content, new Date(groupChat.timestamp));
                  ack(reader, groupChat.id, 1);
              }

              var unReceivedChats = data.unReceivedChats;
              for(var j in unReceivedChats) {
                  var chat = unReceivedChats[j];
                  addMessage(chat.from, chat.to, chat.msg.content, new Date(chat.timestamp));
                  ack(reader, chat.id, 0);
              }
              $("#chatHistory").show();

          });
      }
    </script>
  </head>
  <body>
    <div class="g-doc">
      <div class="g-banner" style="border:none">
        <div class="logo">
          <div class="img"></div>
        </div>
      </div>
      <div class="g-background">
        <div class="g-content">
          Welcome to Pomelo Chats
        </div>
      </div>

      <div class="g-button">
      <tr>
          <td>
             <input id="uid" type="text" placeholder="输入用户名或用户id" />
           </td>
          <td>
              <input id="entry" type="button" value="登陆消息系统" onclick="entry()"/>
          </td>
      </tr>
      </div>

      <div class="g-button">
            <tr>
                <td>
                    消息接收人：<input id="toUid" type="text" placeholder="输入接收用户名或id" />
                </td>
            </tr>
          <tr>
              <td>
                  消息接收的群：<input id="groupId" type="text" placeholder="输入接收的群名或id" />
              </td>
          </tr>
      </div>

      <div class="g-button">
      <tr>
          <span class="input-group-btn">
          <button class="btn btn-default" id="emotion-btn" type="button">
              <img src="/image/emotion_smile.png" style="width:24px;height:24px;">
          </button>
          </span>
          <td>
             消息内容：<input id="msg" class="form-control" type="text" placeholder="输入消息内容" />
          </td>
          <td>
             <input id="sendChat" type="button" value="发送" onclick="sendChat()"/>
          </td>
          <td>
              <input id="sendGroupChat" type="button" value="发送群消息" onclick="sendGroupChat()"/>
          </td>
      </tr>
      </div>

        <div id="chatHistory">
        </div>

    </div>
    <script src="//cdnjscn.b0.upaiyun.com/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>
